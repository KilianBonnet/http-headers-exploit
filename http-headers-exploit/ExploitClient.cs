using http_headers_exploit.website_data;
using System.Text.Json;

namespace http_headers_exploit;

public class ExploitClient
{
    private readonly HttpClient client = new HttpClient{
        Timeout = TimeSpan.FromMilliseconds(500)
    };

    public async Task<Statistics> RequestLoopAsync(string websitesJson) {
        List<Website> websiteList = (List<Website>) JsonSerializer.Deserialize(websitesJson, typeof(List<Website>))!;
        Statistics statistics = new Statistics();
        foreach (var website in websiteList)
        {
            try {
                HttpRequestMessage requestMessage = new HttpRequestMessage(HttpMethod.Head, website.url);
                HttpResponseMessage responseMessage = await client.SendAsync(requestMessage);
                statistics.AddStatistic(responseMessage);
            } catch(TaskCanceledException) {
                statistics.AddTimeout(website.url);
            }
        }

        return statistics;
    }
}
